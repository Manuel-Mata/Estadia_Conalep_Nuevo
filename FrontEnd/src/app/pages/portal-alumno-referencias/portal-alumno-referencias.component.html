<div class="container">
  <header class="header">
    <div class="nav-bar">
      <div>
        🏠 <span class="welcome-text">Portal de Referencias / Portal del Alumno</span>
      </div>
      <div class="user-info">
        <div class="status-indicator"></div>
        <span>En línea</span>
        <span>{{ horaActual | date:'HH:mm:ss' }}</span>
      </div>
    </div>
  </header>

  <main class="main-content">
    <h1 class="portal-title">PORTAL DE REFERENCIAS</h1>

    <!-- FORMULARIO ORGANIZADO -->
    <div class="form-container">
      <form [formGroup]="referenciaForm" (ngSubmit)="generarReferencia()">

        <!-- SECCIÓN 1: DATOS DEL ALUMNO -->
        <div class="form-section">
          <h3>📋 Datos del Alumno</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Matrícula:</label>
              <input type="text" 
                     formControlName="matricula"
                     placeholder="Ingrese su matrícula..."
                     (blur)="buscarAlumno()"
                     class="form-control">
            </div>
          </div>

          <!-- INFORMACIÓN DEL ALUMNO -->
          <div *ngIf="alumnoData" class="alumno-card">
            <div class="alumno-info">
              <h4>✅ Alumno Encontrado</h4>
              <div class="info-grid">
                <div><strong>Matrícula:</strong> {{ alumnoData.matricula }}</div>
                <div><strong>Correo:</strong> {{ alumnoData.correo_institucional }}</div>
                <div><strong>Carrera:</strong> {{ alumnoData.carrera_nombre || 'ELECTROMECÁNICA INDUSTRIAL' }}</div>
                <div><strong>Semestre:</strong> {{ alumnoData.semestre_numero || 6 }}° Semestre</div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 2: SELECCIÓN DE CONCEPTO -->
        <div class="form-section">
          <h3>💰 Concepto de Pago</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Selecciona el concepto:</label>
              <select formControlName="concepto" 
                      class="form-control"
                      (change)="onConceptoChange()">
                <option value="">-- Seleccione un concepto --</option>
                <option *ngFor="let concepto of conceptos" [value]="concepto.codigo_pago">
                  {{ concepto.nombre }} - ${{ concepto.importe | number:'1.2-2' }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- SECCIÓN 3: DATOS ACADÉMICOS -->
        <div class="form-section">
          <h3>🎓 Información Académica</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Período:</label>
              <select formControlName="periodo_id" class="form-control">
                <option value="">-- Seleccione período --</option>
                <option *ngFor="let periodo of periodos" [value]="periodo.id">
                  {{ periodo.nombre }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Carrera:</label>
              <select formControlName="carrera_id" 
                      class="form-control"
                      [disabled]="!!alumnoData?.carrera_id">
                <option value="">-- Seleccione carrera --</option>
                <option *ngFor="let carrera of carreras" [value]="carrera.id">
                  {{ carrera.nombre }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Semestre:</label>
              <select formControlName="semestre_id" 
                      class="form-control"
                      [disabled]="!!alumnoData?.semestre_id">
                <option value="">-- Seleccione semestre --</option>
                <option *ngFor="let semestre of semestres" [value]="semestre.id">
                  {{ semestre.numero }}° SEMESTRE
                </option>
              </select>
            </div>
          </div>

          <!-- MATERIA (solo para asesorías) -->
          <div class="form-row" *ngIf="mostrarMaterias">
            <div class="form-group">
              <label>Materia (para asesorías):</label>
              <select formControlName="materia_id" class="form-control">
                <option value="">-- Seleccione materia --</option>
                <option *ngFor="let materia of materias" [value]="materia.id">
                  {{ materia.nombre }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- BOTÓN GENERAR -->
        <div class="button-section">
          <button type="submit" 
                  class="btn btn-primary btn-large"
                  [disabled]="referenciaForm.invalid || isLoading">
            <span *ngIf="isLoading">🔄 Generando Referencia...</span>
            <span *ngIf="!isLoading">🎫 GENERAR REFERENCIA</span>
          </button>
        </div>

      </form>
    </div>

    <!-- RESULTADO -->
    <div *ngIf="referenciaGenerada" class="resultado-container">
      <div class="resultado-card">
        <h3>✅ Referencia Generada Exitosamente</h3>
        
        <div class="referencia-display">
          <div class="referencia-main">
            <strong>REFERENCIA BANCARIA:</strong>
            <div class="referencia-number">{{ referenciaGenerada.referenciaCompleta }}</div>
          </div>
          
          <div class="referencia-details">
            <div class="detail-item">
              <strong>Concepto:</strong> {{ referenciaGenerada.descripcion }}
            </div>
            <div class="detail-item">
              <strong>Importe:</strong> ${{ referenciaGenerada.importe | number:'1.2-2' }}
            </div>
            <div class="detail-item">
              <strong>Vencimiento:</strong> {{ referenciaGenerada.fechaVencimiento }}
            </div>
            <div class="detail-item">
              <strong>Días vigentes:</strong> {{ referenciaGenerada.diasVigentes }} días
            </div>
          </div>
        </div>

        <!-- BOTONES DESCARGA -->
        <div class="download-buttons">
          <button class="btn btn-success" (click)="descargarPDF()">
            📄 DESCARGAR PDF
          </button>
          <button class="btn btn-info" (click)="descargarPNG()">
            📋 DESCARGAR PNG
          </button>
        </div>
      </div>
    </div>

  </main>

  <footer>
    <button class="btn btn-secondary" (click)="regresar()">
      🚪 REGRESAR
    </button>
  </footer>
</div>